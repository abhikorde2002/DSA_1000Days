def payload = [
                       ["Action", "load number", "carrier", "name", "sequence", "stopType", "AddrLine1", "City", "State", "Postal Code", "Country", "Earliest Time", "Latest Time", "stopPoNumbers", "stopReferenceNumbers"],
                       ["add", "876806", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578616|TW"],
                       ["add", "876806", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578616|TW"],
                       ["add", "876807", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578617|TW"],
                       ["add", "876807", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578617|TW"],
                       ["add", "876808", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578618|TW"],
                       ["add", "876808", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578618|TW"],
                       ["add", "876809", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578619|TW"],
                       ["add", "876809", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578619|TW"],
                       ["add", "876810", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578620|TW"],
                       ["add", "876810", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578620|TW"],
                       ["add", "876811", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578621|TW"],
                       ["add", "876811", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578621|TW"],
                       ["add", "876812", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578622|TW"],
                       ["add", "876812", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578622|TW"],
                       ["add", "876813", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578623|TW"],
                       ["add", "876813", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578623|TW"],
                       ["add", "876814", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578624|TW"],
                       ["add", "876814", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578624|TW"],
                       ["add", "876815", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578625|TW"],
                       ["add", "876815", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578625|TW"],
                       ["add", "876816", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578626|TW"],
                       ["add", "876816", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578626|TW"],
                       ["add", "876817", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578627|TW"],
                       ["add", "876817", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578627|TW"],
                       ["add", "876818", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578628|TW"],
                       ["add", "876818", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578628|TW"],
                       ["add", "876819", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578629|TW"],
                       ["add", "876819", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578629|TW"],
                       ["add", "876820", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578630|TW"],
                       ["add", "876820", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578630|TW"],
                       ["add", "876821", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578631|TW"],
                       ["add", "876821", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578631|TW"],
                       ["add", "876822", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578632|TW"],
                       ["add", "876822", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578632|TW"],
                       ["add", "876823", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578633|TW"],
                       ["add", "876823", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578633|TW"],
                       ["add", "876824", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578634|TW"],
                       ["add", "876824", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578634|TW"],
                       ["add", "876825", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578635|TW"],
                       ["add", "876825", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578635|TW"],
                       ["add", "876826", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578636|TW"],
                       ["add", "876826", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578636|TW"],
                       ["add", "876827", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578637|TW"],
                       ["add", "876827", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578637|TW"],
                       ["add", "876828", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578638|TW"],
                       ["add", "876828", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578638|TW"],
                       ["add", "876829", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578639|TW"],
                       ["add", "876829", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578639|TW"],
                       ["add", "876830", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578640|TW"],
                       ["add", "876830", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578640|TW"],
                       ["add", "876831", "TNKR", "INTERNATIONAL WAXES, INC.", "1", "pickup", "45 Route 446", "Smethport", "PA", "16749", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "", "VOSSLERP|House Account - Sales|   |1578641|TW"],
                       ["add", "876831", "TNKR", "International Waxes, Inc.", "2", "delivery", "Highway 268", "Petrolia", "PA", "16050", "US", "2024-03-22T07.00.00.000Z", "2024-03-22T15.00.00.000Z", "22120241", "VOSSLERP|House Account - Sales|   |1578641|TW"]
               ]



def getPallets(stop) {
    if (!stop.stopId.trim().isEmpty()) {
        pallets = payload.findAll { it[1] == stop.'load number' && it[4] == stop.stopId }
    } else if (!stop.sequence.trim().isEmpty()) {
        pallets = payload.findAll { it[1] == stop.'load number' && it[4] == stop.sequence }
    } else if (!stop.stopType.trim().isEmpty()) {
        pallets = payload.findAll { it[1] == stop.'load number' && it[5] == stop.stopType }
    } else if (stop.autoCreatePorts.toUpperCase().trim() == "TRUE" && !stop.'load number'.trim().isEmpty()) {
        pallets = payload.findAll { it[1] == stop.'load number' }
    }


    pallets.collect { pallet ->
        [
                customerPartNumber: pallet[3].trim(),
                shipperPartNumber: null,
                quantity: null,
                weight: null
        ].findAll { !it.value.isEmpty() }
    }
}
def outputs = [:]

def checkMode(data) {
    return data.toUpperCase().contains('AIRPORT') ? 'AIRPORT' :
            data.toUpperCase().contains('PORT') ? 'OCEAN' :
                    'OTR'
}

def result = []

result = payload.findAll { !it[1].trim().isEmpty() && it[11].toUpperCase().trim() != "TRUE" }.collect { load ->


    [
            BillOfLading: load[1].trim(),
            Operation: load[0].trim().toLowerCase() ?: 'add',
            FileProcessingOption: [
                    use_multi_tpl_relationship: true
            ],
            ConsignmentReferenceNumSequenceNumber: [
                    consignment_reference_num:null,
                    consignment_sequence_num: null
            ],
            ShipperIDfor3pl: load[2]?.trim(),
            Scac: load[2]?.trim(),
            AdditionalData: [
                    operatingCarrierScac: load[2]?.trim(),
            ],
            ProNumber: null,
            TrackingNumber: null,
            MAWB: null,
            ContainerNumber: null,
            BookingNumber: null,
            OceanBillOfLading: (load[12].trim().isEmpty() ? null : load[12].trim()),
            RailEquipmentInitials: null,
            RailEquipmentNumber: null,
            RelayLoad: null,
            LoadReferenceNumbers: load[13],
            Tags: " ",
            Stops: [
                    PickupStops: payload.findAll { it[1] == load[1] && ["pickup", "portofloading", "originairport"].contains(it[5].toLowerCase().trim()) }.collect { stop ->
                        if (stop[5]== 'portofloading') {
                            [
                                    "transportation_mode": 'ocean',
                                   "address_type": 'PORT',
                                    stop_type: 'portOfLoading',
                                    location_id: null,
                                    sequence: stop[4].trim(),
                                    stop_id: null,
                                    ship_to: null,
                                    earliest_arrival_time: stop[11],
                                    latest_arrival_time: stop[12],
                                    reference_numbers: stop[14].trim().tokenize('|').collect { it.trim() },
                                    customer: [
                                            id: null,
                                            po_numbers:  load[13]
                                    ],
                              //      pallets: getPallets(stop)
                            ].findAll { it.value }
                        } else if (stop[5] == 'originairport') {
                            [
                                    transportation_mode: 'air',
                                    stopType: 'originAirport',
                                    sequence: stop[4].trim(),
                                    stop_id: null,
                                    ship_to: null,
                                    earliest_arrival_time: stop[11],
                                    latest_arrival_time: stop[12],
                                    latest_arrival_time: null,
                                    reference_numbers: stop[14].trim().tokenize('|').collect { it.trim() },
                                    departing_flight_number: null,
                                    customer: [
                                            id: null,
                                            po_numbers:  load[13]
                                    ],
                                  //  pallets: getPallets(stop)
                            ].findAll { it.value }
                        } else {

                            [
                                    sequence: stop[4].trim(),
                                    stop_id: null,
                                    ship_to: null,
                                    earliest_arrival_time: stop[11],
                                    latest_arrival_time: stop[12],
                                    reference_numbers: stop[14].trim().tokenize('|').collect { it.trim() },
                                    customer: [
                                            id: null,
                                            po_numbers: load[13]
                                    ],
                                //    pallets: getPallets(stop)
                            ]
                        }
                    },

                    DropOffStops: (payload ?: []).findAll { it[1] == load[1] && ['delivery', 'portofdischarge', 'destinationairport','hubairport'].contains(it[5].toLowerCase().trim()) }.collect { stop ->
                        if (stop[5] == 'portofdischarge') {
                            [
                                    transportation_mode: 'ocean',
                                    address_type: 'PORT',
                                    stop_type: 'null',
                                    location_id: null,
                                    sequence: stop[4].trim(),
                                    stop_id: null,
                                    ship_to: null,
                                    external_address_id: null,
                                    earliest_arrival_time: stop[11],
                                    latest_arrival_time: stop[12],
                                    reference_numbers: stop[14].trim().tokenize('|').collect { it.trim() },
                                    customer: [
                                            id: null,
                                            po_numbers: load[13]
                                    ],
                                  //  pallets: getPallets(stop)
                            ].findAll { it.value }
                        }
                        if (stop[5] == 'hubairport') {
                            [
                                    transportation_mode: 'air',
                                    stop_type: 'hubairport',

                                    sequence: stop[4].trim(),
                                    stop_id: null,
                                    ship_to: null,
                                    external_address_id: null,
                                    earliest_arrival_time: stop[11],
                                    latest_arrival_time: stop[12],
                                    reference_numbers: stop[14].trim().tokenize('|').collect { it.trim() },
                                    customer: [
                                            id: null,
                                            po_numbers: load[13]
                                    ],
                                 //   pallets: getPallets(stop)
                            ].findAll { it.value }
                        }

                        else if (stop[5]== 'destinationairport') {
                            [
                                    transportation_mode: 'air',
                                    stop_type: 'destinationAirport',
                                    sequence: stop[4].trim(),
                                    stop_id: null,
                                    ship_to: null,
                                    external_address_id: null,
                                    earliest_arrival_time: stop[11],
                                    latest_arrival_time: stop[12],
                                    reference_numbers: stop[14].trim().tokenize('|').collect { it.trim() },
                                    departing_flight_number: null,
                                    customer: [
                                            id: null,
                                            po_numbers: load[13]
                                    ],
                                   // pallets: getPallets(stop)
                            ].findAll { it.value }
                        } else {
                            [
                                    sequence: stop[4].trim(),
                                    stop_id: null,
                                    ship_to: null,
                                    earliest_arrival_time: stop[11],
                                    latest_arrival_time: stop[12],
                                    reference_numbers: stop[14].trim().tokenize('|').collect { it.trim() },
                                    customer: [
                                            id: null,
                                            po_numbers: load[13]
                                    ],
                             //       pallets: getPallets(stop)
                            ]
                        }
                    }
            ]
    ]
}

outputs.Loads = result
outputJson = new groovy.json.JsonBuilder(outputs)
print outputJson.toPrettyString()

